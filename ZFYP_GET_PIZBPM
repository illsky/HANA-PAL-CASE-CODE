CREATE PROCEDURE sinopec_ypxs.ZFYP_GET_PIZBPM(
IN OPTI VARCHAR(1),
IN TOPN INT,
IN SQLSEL string,
IN SQLWHERE string,
OUT RESULT1 sinopec_ypxs.FYP_TJFX_PIZBPM1,
OUT RESULT2 sinopec_ypxs.FYP_TJFX_PIZBPM2,
OUT ERROR NVARCHAR(150)
) LANGUAGE SQLSCRIPT 
AS
BEGIN
/*
修改记录：
--20140923 PHQZHAO 创建<PI指标排名分析>；
--20141014 PHQZHAO 修改公司代码IN的报错；
--20141218 PHQZHAO 修改名称
--20150324 PHQZHAO 修改OPTI 1/2的PIZ不一致的问题
--20150515 PHQZHAO 修改QPZ气泡值/销售份额的小数点从5改为2；
--20150619 PHQZHAO 应业务组要求将KZYSJE应收金额改成KZSSJE实收金额；
功能描述：
--从数据源“销售商品柳树分析”Z1FX_XSSPLSFX，根据输入参数，输出PI指标、销售金额、数量等指标；
--OPTI：’1’针对柱图，不用输入SQLSEL(默认明细到商品)，需要输入TOPN，输出RESULT1；’2’针对气泡图和表图，需要输入SQLSEL:大类（GZBZPLDMC),
--中类（GZBZPLZMC），小类（GZBZPLMC），商品（G0TXTLG）,不用输入TOPN，输出RESULT2.
*/
DECLARE SQL_STR CLOB;
DECLARE SUM_XSJE DOUBLE;
DECLARE AVG_XSJE DOUBLE;
DECLARE r2_row INTEGER := 0;
--sql异常情况捕捉
DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
  ERROR := ::SQL_ERROR_MESSAGE || ::SQL_ERROR_CODE;
END;

CREATE LOCAL TEMPORARY Column table #LS_RESULT1 like sinopec_ypxs.FYP_TJFX_PIZBPM1;
CREATE LOCAL TEMPORARY Column table #LS_RESULT2 like sinopec_ypxs.FYP_TJFX_PIZBPM2;
IF :OPTI = '1'
--柱图：商品，PI值；
THEN
IF :TOPN IS NULL OR :TOPN = 0
THEN
SQL_STR :=
'INSERT INTO #LS_RESULT1  select top 100 g0txtlg SPMC, ROUND(A.X/B.Y*1000,2) PIZ from '||
'(select distinct g0txtlg,COUNT(DISTINCT GZTYXSLSH) X from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-fyp/Z1FX_XSSPLSFX" where '||
 :SQLWHERE ||' GROUP BY g0txtlg  ORDER BY X DESC ) A,'||
' (select COUNT(GZTYXSLSH) Y from ( select distinct GZTYXSLSH from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-fyp/Z1FX_XSSPLSFX" where  '||
 :SQLWHERE || ')  ) B ORDER BY PIZ DESC  ' ;
ELSE
SQL_STR :=
'INSERT INTO #LS_RESULT1 select top '||:TOPN ||' g0txtlg SPMC, ROUND(A.X/B.Y*1000,2) PIZ from '||
'(select distinct g0txtlg,COUNT(DISTINCT GZTYXSLSH) X from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-fyp/Z1FX_XSSPLSFX" where '||
 :SQLWHERE ||' GROUP BY g0txtlg  ORDER BY X DESC ) A,'||
' (select COUNT(GZTYXSLSH) Y from ( select distinct GZTYXSLSH from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-fyp/Z1FX_XSSPLSFX" where '||
 :SQLWHERE ||' ) ) B ORDER BY PIZ DESC  ' ;
END IF;
 EXEC :SQL_STR;
ELSEIF  :OPTI = '2'
THEN
--g0txtlg
IF :SQLSEL <> ''
THEN
SQL_STR :=
' INSERT INTO #LS_RESULT2 '||
' select  A.'||:SQLSEL|| 
'  LMS , ROUND(A.X/B.Y*1000,2) PIZ , A.XSJE,A.XSSL,A.JYBS,A.PJDJ,A.KDJ,0 QPZ FROM ( SELECT '||:SQLSEL||
' ,COUNT( GZTYXSLSH ) X,SUM(XSJE) XSJE,SUM(XSSL) XSSL, COUNT( GZTYXSLSH ) JYBS, 
 (case when sum(XSSL) = 0 then 0  else ROUND(sum(XSJE)/sum(XSSL),2)  END )  PJDJ,
 ( CASE WHEN count(GZTYXSLSH) = 0 THEN 0 ELSE ROUND((sum(XSJE))/(count(GZTYXSLSH)),2)  END )   KDJ  
FROM ( SELECT DISTINCT '||:SQLSEL|| 
 ' ,GZTYXSLSH ,sum(KZSSJE) XSJE,sum(KZSPXSSL) XSSL from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-fyp/Z1FX_XSSPLSFX"  where '||:SQLWHERE || 
'GROUP BY '||:SQLSEL||' ,GZTYXSLSH ) GROUP BY '|| :SQLSEL ||
' ) A,  (select COUNT(GZTYXSLSH) Y FROM ( SELECT distinct (GZTYXSLSH) from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-fyp/Z1FX_XSSPLSFX" where  '||:SQLWHERE || 
' ) ) B ORDER BY PIZ DESC' ;
EXEC :SQL_STR;
--类描述，PI值，销售金额，销售数量，交易笔数，平均单价，客单价；
ELSE
ERROR := '商品品类输入不正确。';
END IF ;
END IF;
RESULT1 = SELECT * FROM #LS_RESULT1;
 SELECT count(*) into r2_row FROM #LS_RESULT2;
if r2_row <> 0   then
 SELECT SUM(XSJE) INTO SUM_XSJE FROM #LS_RESULT2;
RESULT2 = SELECT LMS,PIZ,XSJE,XSSL,JYBS,PJDJ,KDJ,
--round(( CASE WHEN :SUM_XSJE = 0 THEN 0 ELSE case when XSJE < 0 then 0 else (XSJE/:SUM_XSJE)*100 end  END),5) QPZ FROM #LS_RESULT2;
round(( CASE WHEN :SUM_XSJE = 0 THEN 0 ELSE case when XSJE < 0 then 0 else (XSJE/:SUM_XSJE)*100 end  END),2) QPZ FROM #LS_RESULT2;
ELSE 
RESULT2 =  SELECT * FROM #LS_RESULT2;
end if;

DROP TABLE #LS_RESULT1;
DROP TABLE #LS_RESULT2;
END;
