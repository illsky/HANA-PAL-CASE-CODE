create procedure SINOPEC_YPXS.ZJYZ_GET_TRIPLESMOOTH_XL(
in username varchar(12),
in CalmonthFrom varchar(6),
in CalmonthTo varchar(6),
in sampleid varchar(40),
IN alpha VARCHAR(10),
in BETA VARCHAR(10),
in GAMMA VARCHAR(10),
in CYCLE VARCHAR(6),
in FSTNUM varchar(6))
--OUT RESULT PQHFANG.PAL_TRIPLESMOOTH_JYZ)
language sqlscript 
SQL security invoker
default schema SAPSR3
--READS SQL DATA 
--WITH RESULT VIEW sinopec_ypxs.PAL_TRIPLESMOOTH_JYZ_LIST
AS
BEGIN  
  declare l_count integer default 1;
  declare l_index integer;
  declare l_k0xskpsl1 double;
  declare l_rid integer;
  declare L_COUNT_REAL integer;
  declare L_COUNT_RESULT int;
  DECLARE L_ALPHA DOUBLE; 
  DECLARE L_BETA DOUBLE;
  DECLARE L_GAMMA DOUBLE;
  DECLARE L_CYCLE INTEGER;
  DECLARE L_FSTNUM INTEGER;   
  DECLARE L_TIME INT;
  DECLARE MESSAGE VARCHAR(50);    
  declare cursor c_kp for 
    SELECT CALMONTH,  ('') as RID,SUM("K0XSKPSL1") K0XSKPSL1    
        FROM _SYS_BIC."sinopec.zbyy.xsyy.z1-jyz/Z1JS_XS00_01"        
        WHERE G0JYZMS IN (SELECT G0JYZMS FROM SAPSR3.Z1ZB_JYZ_LIST WHERE UUID = :sampleid and zcheck <> '')
        AND CALMONTH BETWEEN :CALMONTHFROM AND :CALMONTHTO
        GROUP BY CALMONTH
        ORDER  BY CALMONTH ASC; 
      
   DELETE FROM SINOPEC_YPXS.Z1ZB_PAL_DATA; --数据表
   --DROP TABLE  "SINOPEC_YPXS"."Z1ZB_PAL_DATA";
   --CREATE COLUMN TABLE "SINOPEC_YPXS"."Z1ZB_PAL_DATA" ( "ID" INT ,"RAWDATA" DOUBLE ) 
   
   DELETE FROM SINOPEC_YPXS.Z1ZB_PAL_DATA_DETAIL; --数据表：明细，加入了加油站门市和日历年月
   --DROP TABLE  "SINOPEC_YPXS"."Z1ZB_PAL_DATA_DETAIL";
   --CREATE ROW TABLE "SINOPEC_YPXS"."Z1ZB_PAL_DATA_DETAIL" ( "ID" INT ,"RAWDATA" DOUBLE, CALMONTH VARCHAR(6), G0JYZMS VARCHAR(10))
   L_COUNT := 0;
   
   OPEN c_kp;   
   for c_row as c_kp do  
     l_k0xskpsl1 := c_row.k0xskpsl1;
     l_RID := :l_count;
     
     l_count := :l_count + 1; 
     l_index := :l_index + 1; 
     INSERT INTO SINOPEC_YPXS.Z1ZB_PAL_DATA VALUES(:L_RID,:l_k0xskpsl1) ;      --加油站销量加入到数据表中，ID从0开始
     INSERT INTO SINOPEC_YPXS.Z1ZB_PAL_DATA_DETAIL VALUES(:L_RID,:l_k0xskpsl1, C_ROW.CALMONTH,'') ;  --加油站销量加入到数据明细表中      
   end for;      
   close c_kp;      
   
    PAL_DATA = SELECT * FROM SINOPEC_YPXS.Z1ZB_PAL_DATA;   
    
    select count(*) into l_count_real from :PAL_DATA;
    IF :l_count_real <= 7 THEN  --如果选择期间段内的加油站月度销量条目太少，比如只有一个月的销售数据。那么执行预测函数的时候报错。需要做控制
       message := '' ;
    ELSE
       message := 'CONTINUE' ;
    end IF;
    
    
    IF :MESSAGE = 'CONTINUE' THEN --到月度的加油站基础数据条目够 - 执行预测    
        L_ALPHA := :ALPHA;
        L_BETA  := :BETA;
        L_GAMMA := :GAMMA;
        L_FSTNUM := :FSTNUM;
        L_CYCLE := '12';
 
  --  DROP TABLE SINOPEC_YPXS.Z1ZB_PAL_CONTROL;  
  --  CREATE COLUMN TABLE SINOPEC_YPXS.Z1ZB_PAL_CONTROL  --参数表
  --  ("NAME" varchar(100), "INTARGS" int, "DOUBLEARGS" double, "STRARGS" varchar(100));
        DELETE FROM  SINOPEC_YPXS.Z1ZB_PAL_CONTROL;
        insert into  SINOPEC_YPXS.Z1ZB_PAL_CONTROL values('RAW_DATA_COL',1,NULL,NULL);
        insert into  SINOPEC_YPXS.Z1ZB_PAL_CONTROL values('ALPHA',NULL,:L_ALPHA,NULL);
        insert into  SINOPEC_YPXS.Z1ZB_PAL_CONTROL values('BETA',NULL,:L_BETA,NULL);
        insert into  SINOPEC_YPXS.Z1ZB_PAL_CONTROL values('GAMMA',NULL,:L_GAMMA,NULL);
        insert into  SINOPEC_YPXS.Z1ZB_PAL_CONTROL values('CYCLE',:L_CYCLE,NULL,NULL);
        insert into  SINOPEC_YPXS.Z1ZB_PAL_CONTROL values('STARTTIME',0,NULL,NULL);
        insert into  SINOPEC_YPXS.Z1ZB_PAL_CONTROL values('FORECAST_NUM',:L_FSTNUM,NULL,NULL);
        
        PAL_CONTROL = SELECT * FROM SINOPEC_YPXS.Z1ZB_PAL_CONTROL;
        
    --DROP TABLE SINOPEC_YPXS.PAL_RESULT
    --CREATE COLUMN TABLE SINOPEC_YPXS.Z1ZB_PAL_RESULT ("TIME" INT, "OUTPUT" DOUBLE); 
        PAL_RESULT = SELECT * FROM SINOPEC_YPXS.Z1ZB_PAL_RESULT;   

        CALL _SYS_AFL.ZPAL_TRIPLESMOOTH(:PAL_DATA, :PAL_CONTROL, :PAL_RESULT )with overview;  --三重平滑预算法

        PAL_DATA_DETAIL = SELECT * FROM SINOPEC_YPXS.Z1ZB_PAL_DATA_DETAIL;
      
        RESULT = SELECT R.ID, R.CALMONTH, ROUND(R.RAWDATA/1000,1) AS KF_REAL, 
             F.TIME,ROUND(F.OUTPUT/1000,1) AS KF_FORCAST
             FROM :PAL_DATA_DETAIL AS R
             LEFT JOIN :PAL_RESULT AS F
             ON R.ID = F.TIME             
           UNION 
             SELECT R.ID, R.CALMONTH, ROUND(R.RAWDATA/1000,1) AS KF_REAL, 
             F.TIME,ROUND(F.OUTPUT/1000,1) AS KF_FORCAST
             FROM :PAL_DATA_DETAIL AS R
             RIGHT JOIN :PAL_RESULT AS F
             ON R.ID = F.TIME
             WHERE F.TIME NOT IN
             (SELECT TIME FROM
             (SELECT R.ID, R.CALMONTH, R.RAWDATA AS KF_REAL, 
             F.TIME,F.OUTPUT AS KF_FORCAST
             FROM :PAL_DATA_DETAIL AS R
             INNER JOIN :PAL_RESULT AS F
             ON R.ID = F.TIME));
       
 --      SELECT COUNT(*) INTO L_COUNT_RESULT FROM :RESULT;
 --      L_COUNT := 1;
       
 --      WHILE L_COUNT <= :L_COUNT_RESULT DO
 --        IF 
 --        L_COUNT := :L_COUNT + 1;
 --      END WHILE;
       
       
       SELECT * FROM :RESULT;
       
   ELSE --到月度的加油站基础数据条目够 - 不执行预测函数
         SELECT '' AS ID, '' AS CALMONTH, '' AS KF_REAL, '' AS TIME, '' AS KF_FORCAST
         FROM DUMMY;
   END IF;
end
