create procedure SINOPEC_YPXS.ZKHFX_SET_KHFYGMPH()
LANGUAGE SQLSCRIPT 
AS
BEGIN
/*
修改记录：
--20151125 PKLIU创建<客户非油购买偏好>；
--20151201 HD0XSYYKHFX 增加修改时间ERZET字段插入表"SAPSR3"."Z1ZB_KHGMPH_ZXXX"；

功能描述：
--从数据源 "SAPSR3"."Z1ZB_FYXLGL_ZXXX"非油小类关联和"SAPSR3"."/BIC/AZ1ZBZS5P00"会员主数据
"_SYS_BIC"."sinopec.zbyy.xsyy.z1-khfx/Z1FX_JYMX_HYJYMX"会员交易明细,根据购买偏好相逻辑
计算客户该买偏好并插入表"SAPSR3"."Z1ZB_KHGMPH_ZXXX"
*/

temp=
select GZQYJC,GZHYKH,GZFYJBPL,GZBZPLMC,HYGMPHPX,DIFFPX,A_ITM,A_TXT,GLPX from
(
select A.GZQYJC,a.GZHYKH,a.GZFYJBPL,a.GZBZPLMC,
row_number() over(partition by a.GZHYKH order by a.HYXLGMSL DESC) HYGMPHPX,--会员购买偏好排序
row_number() over(partition by a.GZHYKH order by (a.HYXLGMSL-b.HYGMZSL*c.XLZSLZB)/b.HYGMZSL*c.XLZSLZB DESC) DIFFPX,
d.A_ITM,d.A_TXT,d.GLPX
--select a.GZHYKH,a.GZFYJBPL,a.GZBZPLMC,a.HYXLGMSL,b.HYGMZSL,c.XLZSLZB,
--a.HYXLGMSL/b.HYGMZSL HYXLZB,b.HYGMZSL*c.XLZSLZB HYXLYCGMSL,
--(a.HYXLGMSL-b.HYGMZSL*c.XLZSLZB)/b.HYGMZSL*c.XLZSLZB DIFFERENCE,
from
(--会员各小类购买数量
select GZQYJC,GZHYKH,GZFYJBPL,GZBZPLMC,sum(KZSPXSSL) HYXLGMSL
from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-khfx/Z1FX_JYMX_HYJYMX"
where KZSPXSSL>0
group by GZQYJC,GZHYKH,GZFYJBPL,GZBZPLMC
) a
join
(--会员购买总数量
select GZQYJC,GZHYKH,sum(KZSPXSSL) HYGMZSL
from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-khfx/Z1FX_JYMX_HYJYMX"
where KZSPXSSL>0
group by GZQYJC,GZHYKH
) b 
on a.GZHYKH=b.GZHYKH AND A.GZQYJC = B.GZQYJC
join 
(--各小类销售数量占比
select GZQYJC,GZFYJBPL,
sum(KZSPXSSL)/(select sum(KZSPXSSL) from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-khfx/Z1FX_JYMX_HYJYMX") XLZSLZB
from "_SYS_BIC"."sinopec.zbyy.xsyy.z1-khfx/Z1FX_JYMX_HYJYMX"
where KZSPXSSL>0
group by GZQYJC,GZFYJBPL
) c
on a.GZFYJBPL=c.GZFYJBPL AND A.GZQYJC = C.GZQYJC
join 
(
select GZQYJC,B_ITM,A_ITM,B_TXT,A_TXT,
row_number() over(partition by B_ITM order by SUPPORT,CONFIDENCE,LIFT DESC) GLPX 
from "SAPSR3"."Z1ZB_FYXLGL_ZXXX"
) d
on a.GZFYJBPL=d.B_ITM AND A.GZQYJC = D.GZQYJC
) e
where DIFFPX=1 or HYGMPHPX=1 or HYGMPHPX=2 and GLPX=1;

delete from "SAPSR3"."Z1ZB_KHGMPH_ZXXX";
insert into "SAPSR3"."Z1ZB_KHGMPH_ZXXX"(GZQYJC,GZHYKH,GZKHBH,GZHYKXM,LIKEBM,LIKEMC,AEDAT,ERZET)
select A.GZQYJC,a.GZHYKH,'' GZKHBH,b.GZHYKXM,a.GZFYJBPL,a.GZBZPLMC,
TO_DATS(CURRENT_DATE) AEDAT,
REPLACE(CURRENT_TIME,':','') ERZET
 from
(
select GZQYJC,GZHYKH,GZFYJBPL,GZBZPLMC from :temp
union
select GZQYJC,GZHYKH,A_ITM,A_TXT from :temp
) a
join 
(
select "/BIC/GZQYJC" GZQYJC,"/BIC/GZHYKH" GZHYKH,"/BIC/GZHYKXM" GZHYKXM from "SAPSR3"."/BIC/AZ1ZBZS5P00"
) b
on a.GZHYKH=b.GZHYKH AND A.GZQYJC = B.GZQYJC
order by GZHYKH;

END
